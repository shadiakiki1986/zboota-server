<html>
<head>
<title>Zboota server</title>
<script type="text/javascript" src="js/vendor/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/vendor/jquery.jqplot.js"></script>
<script type="text/javascript" src="js/vendor/pingThis.js"></script>
<script src="client/js/vendor/aws-sdk-2.1.36.min.js"></script>
<script type="text/javascript" src="client/js/AwsManager.js"></script>
<link rel="stylesheet" type="text/css" href="css/vendor/jquery.jqplot.min.css"/>
<script type="text/javascript" src="js/vendor/jqplot.dateAxisRenderer.min-1.0.8r1250.js"></script>
<style>
ul {
  list-style: none;
  margin-left: 0;
  padding-left: 0;
}

li {
  padding-left: 1em;
  text-indent: -1em;
}

li:before {
  content: "...";
  padding-right: 5px;
}

.fail { color: red; }
.pend { color: orange; }
.pass { color: green; }

</style>
</head>
<body>
<img src="img/logo-180.png" alt="Logo" >
<h1>Yet Another Zboota App server</h1>
<p>	This is the server side of my zboota app.
	<h3>Status ...</h3>
	<ul>
	<li>Stats: <span id="response">-</span></li>
	<li>Data sources
		<ul>
		<li><a href="http://www.parkmeterlebanon.com/statment_of_account.aspx">www.parkmeterlebanon.com</a>: <span id="status1b" class="pend">N/A</span></li>
		<li><a href="http://isf.gov.lb/en/speedtickets">www.isf.gov.lb</a>: <span id="status1c" class="pend">N/A</span></li>
		<li><a href="http://www.dawlati.gov.lb/en/mecanique">www.dawlati.gov.lb</a>: <span id="status1d" class="pend">N/A</span></li>
		<li>Retrieval of <a href="http://www.parkmeterlebanon.com/statment_of_account.aspx">www.parkmeterlebanon.com</a>: <span id="status5a" class="pend">N/A</span></li>
		<li>Retrieval of <a href="http://isf.gov.lb/en/speedtickets">www.isf.gov.lb</a>: <span id="status5b" class="pend">N/A</span></li>
		<li>Retrieval of <a href="http://www.dawlati.gov.lb/en/mecanique">www.dawlati.gov.lb</a>: <span id="status5c" class="pend">N/A</span></li>
		</ul>
	</li>
	<li>AWS EC2 PHP API:
		<ul>
		<li>Ping: <span id="status1" class="pend">N/A</span></li>
		<li>Login via API: <span id="status4" class="pend">N/A</span></li>
		<li>Login via App: <span id="status3" class="pend">N/A</span></li>
		<li>Anonymous retrieve: <span id="status2" class="pend">N/A</span></li>
		<li>CI status: <a href="http://travis-ci.org/shadiakiki1986/zboota-server"><img src="https://secure.travis-ci.org/shadiakiki1986/zboota-server.png" alt="travis-ci status"></a></li>
		</ul>
	</li>
	<li>AWS Lambda Nodejs API:
		<ul>
		<li>Anonymous retrieve: <span id="status61" class="pend">N/A</span></li>
		<li>Login via API: <span id="status62" class="pend">N/A</span></li>
		<li>CI status: <a href="http://travis-ci.org/shadiakiki1986/zboota-server-nodejs"><img src="https://secure.travis-ci.org/shadiakiki1986/zboota-server-nodejs.png" alt="travis-ci status"></a></li>
		</ul>
	</li>
	<li>Daily usage: <div id="carsLastGetInPast24HrsChart" style="height:300px; width:500px;"></div></li>
	</ul>
</p>
<script>
(function() {
var req0 = new XMLHttpRequest();
req0.onreadystatechange = function() {
 if (this.readyState == 4) {
 if (this.status != 200) {
    console.log('Error : Status '+this.status+' returned.');
 } else {
    stats=JSON.parse(this.responseText);
    document.getElementById('response').innerHTML = stats.cars+" cars, " + stats.users+" registered users (of which " + stats.notifications+" with outstanding tickets)";

    var plot1 = jQuery.jqplot ('carsLastGetInPast24HrsChart',
	[stats.carsLastGetInPast24Hrs.nTotal,
	 stats.carsLastGetInPast24Hrs.nNew], 
      { 
	title: { text: "Number of cars checked daily" },
	axes:{
		xaxis:{
		  renderer:$.jqplot.DateAxisRenderer,
		 tickOptions:{formatString:'%b %#d\n%Y'},
		  tickInterval:'1 week'
		}
	},
        seriesDefaults: {
          rendererOptions: {
            // Put data labels on the pie slices.
            // By default, labels show the percentage of the slice.
            showDataLabels: true
          }
        }, 
        legend: { show:true, location: 'nw', labels: ["Total","New"] }
      }
    );

  }
 }
}
req0.open('GET', 'http://genesis.akikieng.com/zboota-server/api/statistics.php', true);
req0.send(null);
//-------------------------------------------------
var req1 = new XMLHttpRequest();
req1.onreadystatechange = function() {
 document.getElementById('status1').innerHTML="Pending";
 if (this.readyState == 4) {
   document.getElementById('status1').innerHTML = this.status!=200 ? "Error" : "Working";
   document.getElementById('status1').className = this.status!=200 ? "fail" : "pass";
 }
}
req1.open('GET', 'http://genesis.akikieng.com/zboota-server/api/get2.php', true);
req1.send(null);
//-------------------------------------------------
pingThis("http://www.parkmeterlebanon.com/Picutres/header_website_copy.jpg",
	function() { document.getElementById('status1b').innerHTML="Pending"; },
	function() {
		document.getElementById('status1b').innerHTML = "Error";
		document.getElementById('status1b').className = "fail";
	},
	function() {
		document.getElementById('status1b').innerHTML = "Working";
		document.getElementById('status1b').className = "pass";
	}
).init();
//-------------------------------------------------
pingThis("http://isf.gov.lb/images/top_logo.png",
	function() { document.getElementById('status1c').innerHTML="Pending"; },
	function() {
		document.getElementById('status1c').innerHTML = "Error";
		document.getElementById('status1c').className = "fail";
	},
	function() {
		document.getElementById('status1c').innerHTML = "Working";
		document.getElementById('status1c').className = "pass";
	}
).init();
//-------------------------------------------------
pingThis("http://www.dawlati.gov.lb/dawlati-standard-theme/images/ministry/dawlati_en.png",
	function() { document.getElementById('status1d').innerHTML="Pending"; },
	function() {
		document.getElementById('status1d').innerHTML = "Error";
		document.getElementById('status1d').className = "fail";
	},
	function() {
		document.getElementById('status1d').innerHTML = "Working";
		document.getElementById('status1d').className = "pass";
	}
).init();
//-------------------------------------------------
var req2 = new XMLHttpRequest();
req2.onreadystatechange = function() {
 document.getElementById('status2').innerHTML="Pending";
 if (this.readyState == 4) {
   if (this.status != 200) {
     document.getElementById('status2').innerHTML = "Error 1";
     document.getElementById('status2').className = "fail";
   } else {
     if(this.responseText=="") {
       document.getElementById('status2').innerHTML = "Error 2";
       document.getElementById('status2').className = "fail";
     } else {
       rt=JSON.parse(this.responseText);
console.log(rt);
       if(rt.hasOwnProperty("error") || !rt.hasOwnProperty("B/1234")) {
         document.getElementById('status2').innerHTML = "Error";
         document.getElementById('status2').className = "fail";
       } else {
         rt=rt["B/1234"];
         cond=rt.pml=="None" && rt.n=="1234" && rt.a=="B" && (rt.isf=="None"|| /\d{2}\/\d{2}\/\d{2}/.test(rt.isf));
         document.getElementById('status2').innerHTML = cond ? "Working" : "Error";
         document.getElementById('status2').className = cond ? "pass" : "fail";
       }
     }
   }
  }

}
req2.open('POST', 'http://genesis.akikieng.com/zboota-server/api/get2.php', true);
req2.send(JSON.stringify({"lpns":"[{\"a\":\"B\",\"n\":\"1234\",\"l\":\"test\",\"isf\":\"None\",\"pml\":\"None\"}]"}));
//-------------------------------------------------
AWS.config.region = 'us-east-1'; // Region
AWS.config.credentials = new AWS.CognitoIdentityCredentials({
  IdentityPoolId: 'us-east-1:639fd2a8-8277-4726-b9b3-3231ed0d5f71',
});
AWS.config.httpOptions = { timeout: 5000 }; 
var awsMan = new AwsManager();
//-------------------------------------------------
var req3a = new XMLHttpRequest();
req3a.onreadystatechange = function() {
 document.getElementById('status3').innerHTML="Pending";
 if (this.readyState == 4) {
   if (this.status != 200) {
     document.getElementById('status3').innerHTML = "Error 1";
     document.getElementById('status3').className = "fail";
     document.getElementById('status4').innerHTML = "Error 1";
     document.getElementById('status4').className = "fail";
   } else {
     if(this.responseText=="") {
       document.getElementById('status3').innerHTML = "Error 2";
       document.getElementById('status3').className = "fail";
       document.getElementById('status4').innerHTML = "Error 2";
       document.getElementById('status4').className = "fail";
     } else {
        pass=this.responseText;
        //-----------------------------
        var req3 = new XMLHttpRequest();
        req3.onreadystatechange = function() {
         document.getElementById('status3').innerHTML="Pending";
         if (this.readyState == 4) {
           if (this.status != 200) {
             document.getElementById('status3').innerHTML = "Error 3";
             document.getElementById('status3').className = "fail";
           } else {
		re=new RegExp("{.*}");
               document.getElementById('status3').innerHTML = re.test(this.responseText) ? "Working" : "Error";
               document.getElementById('status3').className = re.test(this.responseText) ? "pass" : "fail";
           }
          }

        }
        req3.open('POST', 'http://genesis.akikieng.com/zboota-server/api/login.php', true);
        params="email=shadi_akiki_1986@hotmail.com&pass="+pass;
        req3.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        req3.setRequestHeader("Content-length", params.length);
        req3.setRequestHeader("Connection", "close");
        req3.send(params);
        //---------------------------
        var req4 = new XMLHttpRequest();
        req4.onreadystatechange = function() {
         document.getElementById('status4').innerHTML="Pending";
         if (this.readyState == 4) {
           if (this.status != 200) {
             document.getElementById('status4').innerHTML = "Error 3";
             document.getElementById('status4').className = "fail";
           } else {
               cond=new RegExp("<table><tr><th>Letter</th><th>Number</th><th>Label</th><th>ISF</th><th>PML</th></tr>.*</table>");
               document.getElementById('status4').innerHTML = cond.test(this.responseText) ? "Working" : "Error";
               document.getElementById('status4').className = cond.test(this.responseText) ? "pass" : "fail";
           }
          }

        }
        req4.open('GET', 'http://genesis.akikieng.com/zboota-server/api/login2.php?email=shadi_akiki_1986@hotmail.com&pass='+pass, true);
        req4.send(params);
        //------------------------------
	awsMan.invokeLambda('zboota-login',{"email":"shadi_akiki_1986@hotmail.com","pass":pass},function(err, data) {
	  if (err||data.StatusCode!=200) {
	     document.getElementById('status62').innerHTML = "Error 1";
	     document.getElementById('status62').className = "fail";
	  } else {
	    rt=data.Payload; // rt=JSON.parse(data.Payload);
	    re=new RegExp("{.*}");
	    document.getElementById('status62').innerHTML = re.test(rt) ? "Working" : "Error";
	    document.getElementById('status62').className = re.test(rt) ? "pass" : "fail";
	  }
	});

     }
   }
  }

}
req3a.open('GET', 'http://genesis.akikieng.com/zboota-server/api/testUserPassword.php', true);
req3a.send(null);
//-------------------------------------------------
var req5 = new XMLHttpRequest();
req5.onreadystatechange = function() {
 if (this.readyState == 4) {
   if (this.status != 200) {
     document.getElementById('status5a').innerHTML = "Error";
     document.getElementById('status5a').className = "fail";
     document.getElementById('status5b').innerHTML = "Error";
     document.getElementById('status5b').className = "fail";
     document.getElementById('status5c').innerHTML = "Error";
     document.getElementById('status5c').className = "fail";
   } else {
    avail=JSON.parse(this.responseText);
    document.getElementById('status5a').innerHTML = avail.pml==1 ? "On" : "Off";
    document.getElementById('status5a').className = avail.pml==1 ? "pass" : "fail";
    document.getElementById('status5b').innerHTML = avail.isf==1?"On":"Off";
    document.getElementById('status5b').className = avail.isf==1 ? "pass" : "fail";
    document.getElementById('status5c').innerHTML = avail.dawlati==1?"On":"Off";
    document.getElementById('status5c').className = avail.dawlati==1 ? "pass" : "fail";
   }
 }
}
req5.open('GET', 'http://genesis.akikieng.com/zboota-server/api/getWebAvailability.php', true);
req5.send(null);
//-------------------------------------------------
awsMan.invokeLambda('zboota-get',[{"n":"123","a":"B"}],function(err, data) {
  if (err||data.StatusCode!=200) {
     document.getElementById('status61').innerHTML = "Error 1";
     document.getElementById('status61').className = "fail";
  } else {
    rt=data.Payload; // rt=JSON.parse(data.Payload);
    re=new RegExp("{.*}");
    document.getElementById('status61').innerHTML = re.test(rt) ? "Working" : "Error";
    document.getElementById('status61').className = re.test(rt) ? "pass" : "fail";
  }
});

}());

</script>

<h3>The zboota app itself allows you to ...</h3>
<ul>
<li>add multiple car plate numbers</li>
<li>see any outstanding violations with
	<a href="http://www.isf.gov.lb/en/speedtickets"><img src="img/isf-top_logo_en.png" alt="ISF" /></a>
	and <a href="http://www.parkmeterlebanon.com/statment_of_account.aspx"><img src="img/pml-header_website_copy.jpg" alt="PML" /></a>.
</li>
<li>see your cars' mechanique schedule/fee from 
	<a href="http://www.dawlati.gov.lb/en/mecanique"><img src="img/dawlati_en.png" alt="Dawlati"/></a>
</li>
<li>register an email address</li>
<li>log in with a registered email address</li>
</ul>
<h3>The purpose of the server is to ...</h3>
<ul>
<li>provide the back-end for the app, </li>
<li>expose a simple <a href="http://genesis.akikieng.com/zboota-server/api">API</a> for interested users, </li>
<li>serve the app as a <a href="client">web page</a> for usage in browsers, </li>
<li>and to serve this page.</li>
</ul>
<h3>Registering your email on the app allows you to ...</h3>
<ul>
<li>save your list of car numbers in case you log in from another device</li>
<li>receive an email as soon as one of your added car plate numbers has an associated violation</li>
</ul>
<h3>The zboota app is published on ...</h3>
<ul>
<li><a href="https://play.google.com/store/apps/details?id=com.akikieng.genesis.zbootaapp"><img src="img/store-google.png" alt="Google Play" /></a> for android devices</li>
<li><a href="https://itunes.apple.com/WebObjects/MZStore.woa/wa/viewSoftware?id=974745846&mt=8"><img src="img/store-apple.png" alt="Apple Store" /></a> for iOS devices</li>
<li><a href="client"><img src="img/desktop_web.jpeg" alt="this server for web browsers" /></a></li>
<li><a href="https://github.com/shadiakiki1986/zboota-app"><img src="img/github_commits_logo.png" alt="Github" height="100px" width="100px" /></a> for the open-source community</li>
<li><a href="https://www.facebook.com/yaza4"><img src="img/facebook-logo-icon-02.png" alt="facebook page" /></a> for social interaction purposes</li>
</ul>
<h3>Please note that ...</h3>
<ul>
<li>this app and its infrastructure were developed solely to serve my personal needs.</li>
<li>your constructive feedback is welcome</li>
<li>I do not take any responsibility not whatsoever for any mistakes that may cause you to be fined.</li>
<li>the data belongs to its sole owners:
	&nbsp;<a href="http://www.isf.gov.lb/en/speedtickets"><img src="img/isf-top_logo_en.png" alt="ISF" /></a>
	&nbsp;<a href="http://www.parkmeterlebanon.com/"><img src="img/pml-header_website_copy.jpg" alt="PML" /></a>
	&nbsp;<a href="http://www.dawlati.gov.lb/en/mecanique"><img src="img/dawlati_en.png" alt="Dawlati"/></a>
</li>
<li>the app itself is licensed under <a href="http://wtfpl.net"><img src="img/wtfpl-logo-220x1601.png" alt="WTFPL" width="110px" height="80px" /></a>,</li>
<li>there are similar apps out there, like <a href="https://play.google.com/store/apps/details?id=air.speedTicketLebanon">this</a>,
<a href="http://www.appszoom.com/android_applications/tools/lebanese-traffic-ticket_inbfc.html">this</a>,
<a href="https://play.google.com/store/apps/details?id=com.stround.lebanoncarfines">this</a>,
<a href="https://play.google.com/store/apps/details?id=com.tesladroid.lebanontickets">this</a>,
and <a href="https://play.google.com/store/apps/details?id=com.omr.zbt">this</a></li>
</ul>
</body>
</html>
